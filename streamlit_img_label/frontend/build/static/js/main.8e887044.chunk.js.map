{"version":3,"sources":["StreamlitImgLabel.module.css","StreamlitImgLabel.tsx","index.tsx"],"names":["module","exports","withStreamlitConnection","props","mode","setMode","useState","canvas","setCanvas","fabric","Canvas","canvasWidth","canvasHeight","imageData","args","newBBoxIndex","setNewBBoxIndex","newPointIndex","setNewPointIndex","newNegativePointIndex","setNewNegativePointIndex","invisCanvas","document","createElement","ctx","getContext","dataUri","width","height","idata","createImageData","data","set","putImageData","toDataURL","useEffect","canvasTmp","enableRetinaScaling","backgroundImage","uniScaleTransform","Streamlit","setFrameHeight","sendCoordinates","rects","getObjects","filter","rect","isType","map","i","getBoundingRect","points","point","getCenterPoint","label","negativePoints","setComponentValue","on","handleEvent","renderAll","off","onSelectMode","body","classList","add","remove","window","matchMedia","addEventListener","e","matches","removeEventListener","React","Fragment","id","className","styles","dark","onClick","addBoxHandler","box","left","top","Rect","fill","objectCaching","stroke","boxColor","strokeWidth","strokeUniform","hasRotatingPoint","addPointHandler","Circle","radius","pointColor","addNegativePointHandler","negativePointColor","removeHandler","selectObject","getActiveObject","clearAllHandler","forEach","object","ReactDOM","render","StrictMode","StreamlitImgLabel","getElementById"],"mappings":"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","file":"static/js/main.8e887044.chunk.js","sourcesContent":["// extracted by mini-css-extract-plugin\nmodule.exports = {\"dark\":\"StreamlitImgLabel_dark__PyW4C\"};","import React, { useEffect, useState } from \"react\"\nimport {\n    ComponentProps,\n    Streamlit,\n    withStreamlitConnection,\n} from \"streamlit-component-lib\"\nimport { fabric } from \"fabric\"\nimport styles from \"./StreamlitImgLabel.module.css\"\n\nconst NEGATIVE_POINT_LABEL: number = 0\nconst POINT_LABEL: number = 1\n\ninterface FabricObjectProps {\n    top: number\n    left: number\n    width: number\n    height: number\n}\n\ninterface PythonArgs {\n    canvasWidth: number\n    canvasHeight: number\n    rects: FabricObjectProps[]\n    points: FabricObjectProps[]\n    negativePoints: FabricObjectProps[]\n    boxColor: string\n    pointColor: string\n    negativePointColor: string\n    imageData: Uint8ClampedArray\n}\n\nconst StreamlitImgLabel = (props: ComponentProps) => {\n    const [mode, setMode] = useState<string>(\"light\")\n    const [canvas, setCanvas] = useState(new fabric.Canvas(\"\"))\n    const { canvasWidth, canvasHeight, imageData }: PythonArgs = props.args\n    const [newBBoxIndex, setNewBBoxIndex] = useState<number>(0)\n    const [newPointIndex, setNewPointIndex] = useState<number>(0)\n    const [newNegativePointIndex, setNewNegativePointIndex] = useState<number>(0)\n\n    /*\n     * Translate Python image data to a JavaScript Image\n     */\n    var invisCanvas = document.createElement(\"canvas\")\n    var ctx = invisCanvas.getContext(\"2d\")\n\n    invisCanvas.width = canvasWidth\n    invisCanvas.height = canvasHeight\n\n    // create imageData object\n    let dataUri: any\n    if (ctx) {\n        var idata = ctx.createImageData(canvasWidth, canvasHeight)\n\n        // set our buffer as source\n        idata.data.set(imageData)\n\n        // update canvas with new data\n        ctx.putImageData(idata, 0, 0)\n        dataUri = invisCanvas.toDataURL()\n    } else {\n        dataUri = \"\"\n    }\n\n    // Initialize canvas on mount and add a rectangle\n    useEffect(() => {\n        // const { points, rects, boxColor, pointColor }: PythonArgs = props.args\n        const canvasTmp = new fabric.Canvas(\"c\", {\n            enableRetinaScaling: false,\n            backgroundImage: dataUri,\n            uniScaleTransform: true,\n        })\n\n        // rects.forEach((rect) => {\n        //     const { top, left, width, height } = rect\n        //     canvasTmp.add(\n        //         new fabric.Rect({\n        //             left,\n        //             top,\n        //             fill: \"\",\n        //             width,\n        //             height,\n        //             objectCaching: true,\n        //             stroke: boxColor,\n        //             strokeWidth: 1,\n        //             strokeUniform: true,\n        //             hasRotatingPoint: false,\n        //         })\n        //     )\n        // })\n\n        setCanvas(canvasTmp)\n        Streamlit.setFrameHeight()\n        // eslint-disable-next-line\n    }, [canvasHeight, canvasWidth, dataUri])\n\n    // Create defualt bounding box\n    const defaultBox = () => ({\n        left: canvasWidth * 0.15 + newBBoxIndex * 3,\n        top: canvasHeight * 0.15 + newBBoxIndex * 3,\n        width: canvasWidth * 0.2,\n        height: canvasHeight * 0.2,\n    })\n\n    const defaultPoint = () => ({\n        left: canvasWidth * 0.15 + newPointIndex * 3,\n        top: canvasHeight * 0.15 + newPointIndex * 3,\n        width: canvasWidth * 0.01,\n        height: canvasHeight * 0.01,\n    })\n\n    const defaultNegativePoint = () => ({\n        left: canvasWidth * 0.15 + newNegativePointIndex * 3,\n        top: canvasHeight * 0.15 + newNegativePointIndex * 3,\n        width: canvasWidth * 0.01,\n        height: canvasHeight * 0.01,\n    })\n\n    // Add new bounding box to be image\n    const addBoxHandler = () => {\n        if (newBBoxIndex === 50) {\n            setNewBBoxIndex(0);\n        } else {\n            setNewBBoxIndex(newBBoxIndex + 1);\n        }\n        const box = defaultBox()\n        canvas.add(\n            new fabric.Rect({\n                ...box,\n                fill: \"\",\n                objectCaching: true,\n                stroke: props.args.boxColor,\n                strokeWidth: 1,\n                strokeUniform: true,\n                hasRotatingPoint: false,\n            })\n        )\n        sendCoordinates()\n    }\n\n    const addPointHandler = () => {\n        if (newPointIndex === 50) {\n            setNewPointIndex(0);\n        } else {\n            setNewPointIndex(newPointIndex + 1);\n        }\n        const point = defaultPoint()\n        canvas.add(\n            new fabric.Circle({\n                ...point,\n                data: POINT_LABEL,\n                radius: point.width,\n                fill: props.args.pointColor,\n                objectCaching: true,\n                stroke: props.args.pointColor,\n                strokeWidth: 1,\n                strokeUniform: true,\n                hasRotatingPoint: false,\n            })\n        )\n        sendCoordinates()\n    }\n\n    const addNegativePointHandler = () => {\n        if (newNegativePointIndex === 50) {\n            setNewNegativePointIndex(0);\n        } else {\n            setNewNegativePointIndex(newNegativePointIndex + 1);\n        }\n        const point = defaultNegativePoint()\n        canvas.add(\n            new fabric.Circle({\n                ...point,\n                data: NEGATIVE_POINT_LABEL,\n                radius: point.width,\n                fill: props.args.negativePointColor,\n                objectCaching: true,\n                stroke: props.args.negativePointColor,\n                strokeWidth: 1,\n                strokeUniform: true,\n                hasRotatingPoint: false,\n            })\n        )\n        sendCoordinates()\n    }\n\n    // Remove the selected bounding box\n    const removeHandler = () => {\n        // const selectIndex = canvas.getObjects().indexOf(selectObject)\n        const selectObject = canvas.getActiveObject()\n        canvas.remove(selectObject)\n        sendCoordinates()\n    }\n\n    // Remove all the bounding boxes\n    const clearAllHandler = () => {\n        setNewBBoxIndex(0)\n        setNewPointIndex(0)\n        setNewNegativePointIndex(0)\n        canvas.getObjects().forEach((object) => canvas.remove(object))\n        sendCoordinates()\n    }\n\n    // Send the coordinates of the rectangle back to streamlit.\n    const sendCoordinates = () => {\n        const rects = canvas.getObjects()\n            .filter(rect => rect.isType(\"rect\"))\n            .map((rect, i) => ({\n                ...rect.getBoundingRect()\n            }))\n        const points = canvas.getObjects()\n            .filter(point => point.isType(\"circle\") && point.data === POINT_LABEL)\n            .map((point, i) => ({\n                ...point.getCenterPoint(),\n                label: POINT_LABEL,\n            }))\n        const negativePoints = canvas.getObjects()\n            .filter(point => point.isType(\"circle\") && point.data === NEGATIVE_POINT_LABEL)\n            .map((point, i) => ({\n                ...point.getCenterPoint(),\n                label: NEGATIVE_POINT_LABEL,\n            }))\n        Streamlit.setComponentValue({ rects, points, negativePoints })\n    }\n\n    // Update the bounding boxes when modified\n    useEffect(() => {\n        if (!canvas) {\n            return\n        }\n        const handleEvent = () => {\n            canvas.renderAll()\n            sendCoordinates()\n        }\n\n        canvas.on(\"object:modified\", handleEvent)\n        return () => {\n            canvas.off(\"object:modified\")\n        }\n    })\n\n    // Adjust the theme according to the system\n    const onSelectMode = (mode: string) => {\n        setMode(mode)\n        if (mode === \"dark\") document.body.classList.add(\"dark-mode\")\n        else document.body.classList.remove(\"dark-mode\")\n    }\n\n    useEffect(() => {\n        // Add listener to update styles\n        window\n            .matchMedia(\"(prefers-color-scheme: dark)\")\n            .addEventListener(\"change\", (e) =>\n                onSelectMode(e.matches ? \"dark\" : \"light\")\n            )\n\n        // Setup dark/light mode for the first time\n        onSelectMode(\n            window.matchMedia(\"(prefers-color-scheme: dark)\").matches\n                ? \"dark\"\n                : \"light\"\n        )\n\n        // Remove listener\n        return () => {\n            window\n                .matchMedia(\"(prefers-color-scheme: dark)\")\n                .removeEventListener(\"change\", () => {})\n        }\n    }, [])\n\n    return (\n        <>\n            <canvas\n                id=\"c\"\n                className={mode === \"dark\" ? styles.dark : \"\"}\n                width={canvasWidth}\n                height={canvasHeight}\n            />\n            <div className={mode === \"dark\" ? styles.dark : \"\"}>\n                <button\n                    className={mode === \"dark\" ? styles.dark : \"\"}\n                    onClick={addBoxHandler}\n                >\n                    새로운 박스 생성\n                </button>\n                <button\n                    className={mode === \"dark\" ? styles.dark : \"\"}\n                    onClick={addPointHandler}\n                >\n                    새로운 포인트 생성\n                </button>\n                <button\n                    className={mode === \"dark\" ? styles.dark : \"\"}\n                    onClick={addNegativePointHandler}\n                >\n                    새로운 네거티브 포인트 생성\n                </button>\n                <button\n                    className={mode === \"dark\" ? styles.dark : \"\"}\n                    onClick={removeHandler}\n                >\n                    선택한 박스/포인트 제거\n                </button>\n                <button\n                    className={mode === \"dark\" ? styles.dark : \"\"}\n                    onClick={clearAllHandler}\n                >\n                    모든 박스/포인트 제거\n                </button>\n            </div>\n        </>\n    )\n}\n\nexport default withStreamlitConnection(StreamlitImgLabel)\n","import React from \"react\"\nimport ReactDOM from \"react-dom\"\nimport StreamlitImgLabel from \"./StreamlitImgLabel\"\n\nReactDOM.render(\n  <React.StrictMode>\n    <StreamlitImgLabel />\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n)\n"],"sourceRoot":""}